<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <title>.NET アプリケーション開発入門</title>
  <!-- Bootstrap -->
  <link href="./lib/css/bootstrap.min.css" rel="stylesheet">
  <link href="./css/base.css" rel="stylesheet">
  <!-- highlightjs -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://kazunori-kimura.github.io/how-to-develop-dot-net-apps/"><i class="fa fa-code"></i> .NET アプリケーション開発入門</a>
      </div>
      <p class="navbar-text navbar-right">
        <a href="https://github.com/Kazunori-Kimura/introduction-to-asp-dot-net" class="navbar-link" target="_blank">
          <i class="fa fa-github"></i>
          View on GitHub
        </a>
        &nbsp;
      </p>
    </div>
  </nav>

  <div class="container-fluid contents">
    <div class="row">
      <div class="col-md-2"></div>
      <div class="col-md-7">
        <!-- contents -->
        <h1 id="4-">4. 薬品情報検索システムの開発</h1>
<p>前回作成した <em>DrugInfoSearch</em> に手を加え、
検索機能と薬効分類のメンテナンス機能を作成します。</p>
<p><br></p>
<h2 id="-">検索画面の追加</h2>
<p>薬品名と薬効分類で絞込を行う機能を追加します。</p>
<h3 id="-">コントローラの追加</h3>
<p><em>ソリューション エクスプローラー</em> で <em>Controllers</em> を右クリックし、<em>追加</em> -&gt; <em>コントローラー</em> を選択します。</p>
<p><img src="./images/a3-1.JPG" alt="image">
<br></p>
<p><em>MVC5 コントローラー - 空</em> を選択します。</p>
<p><img src="./images/a3-2.JPG" alt="image">
<br></p>
<p>名前を <em>HomeController</em> とします。</p>
<p><img src="./images/a3-3.JPG" alt="image"></p>
<p><br><br></p>
<h3 id="viewmodel-">ViewModelの作成</h3>
<p>これまではデータベースのテーブル構造から自動生成されたモデルクラスを使用してきましたが、
自動生成されたモデルクラスでは検索条件を格納するのに適切なプロパティがないために
データの受け渡しが上手くできません。</p>
<p>このような場合、<em>View</em> で扱うデータを定義する <em>ViewModel</em> を作成します。</p>
<p><br></p>
<p><em>ソリューション エクスプローラー</em> で <em>Models</em> を右クリックし、<em>追加</em> -&gt; <em>クラス</em> を選択します。</p>
<p>クラス名を <code>SearchViewModel</code> とします。</p>
<p><code>Models/SearchViewModel.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.ComponentModel;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">WebApplication1.Models</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SearchViewModel</span>
    {
        [DisplayName(<span class="hljs-string">"薬品名"</span>)]
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> DrugName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [DisplayName(<span class="hljs-string">"薬効分類"</span>)]
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> ClassificationId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-keyword">public</span> List&lt;Drugs&gt; Drugs { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
}
</code></pre>
<p><br><br></p>
<h3 id="index-get-post-">Index アクションメソッド (GET/POST) の作成</h3>
<p><em>Index</em> の <em>GET</em>, <em>POST</em> に対応するアクションメソッドを実装します。</p>
<p><code>Controllers/HomeController.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Web.Mvc;
<span class="hljs-keyword">using</span> WebApplication1.Models;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">WebApplication1.Controllers</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HomeController</span> : <span class="hljs-title">Controller</span>
    {
        <span class="hljs-keyword">private</span> DrugInfoContext db = <span class="hljs-keyword">new</span> DrugInfoContext();

        <span class="hljs-comment">// GET: Home</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult <span class="hljs-title">Index</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-keyword">this</span>.SetClassificationItems();

            <span class="hljs-comment">// Viewでの処理を簡単にするため、空のViewModelを渡す</span>
            <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> SearchViewModel();
            <span class="hljs-keyword">return</span> View(model);
        }

        <span class="hljs-comment">// POST: Home</span>
        [HttpPost]
        [ValidateAntiForgeryToken]
        <span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult <span class="hljs-title">Index</span>(<span class="hljs-params">[Bind(Include = <span class="hljs-string">"DrugName,ClassificationId"</span></span>)] SearchViewModel model)
        </span>{
            <span class="hljs-keyword">if</span> (ModelState.IsValid)
            {
                <span class="hljs-comment">// 検索処理</span>
                <span class="hljs-keyword">var</span> list = db.Drugs.Where(item =&gt;
                    (<span class="hljs-keyword">string</span>.IsNullOrEmpty(model.DrugName) || item.Name.Contains(model.DrugName))
                    &amp;&amp; (model.ClassificationId == <span class="hljs-number">0</span> || item.ClassificationId == model.ClassificationId)).ToList();
                model.Drugs = list;
            }
            <span class="hljs-keyword">this</span>.SetClassificationItems();
            <span class="hljs-keyword">return</span> View(model);
        }

        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> ViewBagにコンボボックスの項目をセット</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetClassificationItems</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-keyword">var</span> list = db.Classifications.Select(item =&gt; <span class="hljs-keyword">new</span> SelectListItem
            {
                Text = item.ClassificationCode + <span class="hljs-string">":"</span> + item.Name,
                Value = item.ClassificationId.ToString()
            }).ToList();

            <span class="hljs-comment">// 先頭にブランクを挿入</span>
            list.Insert(<span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> SelectListItem {
                Text = <span class="hljs-keyword">string</span>.Empty,
                Value = <span class="hljs-string">"0"</span>
            });

            ViewBag.ClassificationId = list;
        }
    }
}
</code></pre>
<p><br><br></p>
<h3 id="index-view-">Index Viewの作成</h3>
<p><em>HomeController</em> の <em>Index</em> メソッドを右クリックし、<em>Viewの追加</em> を選択します。</p>
<p><img src="./images/a3-4.JPG" alt="image"></p>
<p><br></p>
<p><em>ビューの追加</em> で以下のように入力し、<em>追加</em> をクリックします。</p>
<p><img src="./images/a3-5.JPG" alt="image"></p>
<ul>
<li>モデル: <em>SearchViewModel</em></li>
<li>テンプレート: <em>Create</em></li>
<li>データ コンテキスト クラス: (空)</li>
</ul>
<p><br></p>
<p><code>Views/Home/Index.cshtml</code></p>
<pre><code class="lang-html"><span class="hljs-annotation">@model</span> <span class="hljs-type">WebApplication1</span>.<span class="hljs-type">Models</span>.<span class="hljs-type">SearchViewModel</span>

@{
    <span class="hljs-type">ViewBag</span>.<span class="hljs-type">Title</span> = <span class="hljs-string">"Index"</span>;
}

<span class="hljs-annotation">@using</span> (<span class="hljs-type">Html</span>.<span class="hljs-type">BeginForm</span>())
{
    <span class="hljs-annotation">@Html</span>.<span class="hljs-type">AntiForgeryToken</span>()

    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-horizontal"</span>&gt;
        &lt;h4&gt;<span class="hljs-type">SearchViewModel</span>&lt;/h4&gt;
        &lt;hr /&gt;
        <span class="hljs-annotation">@Html</span>.<span class="hljs-type">ValidationSummary</span>(<span class="hljs-literal">true</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"text-danger"</span> })
        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
            <span class="hljs-annotation">@Html</span>.<span class="hljs-type">LabelFor</span>(model =&gt; model.<span class="hljs-type">DrugName</span>, htmlAttributes: <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"control-label col-md-2"</span> })
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-md-10"</span>&gt;
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">EditorFor</span>(model =&gt; model.<span class="hljs-type">DrugName</span>, <span class="hljs-keyword">new</span> { htmlAttributes = <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"form-control"</span> } })
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">ValidationMessageFor</span>(model =&gt; model.<span class="hljs-type">DrugName</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"text-danger"</span> })
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
            <span class="hljs-annotation">@Html</span>.<span class="hljs-type">LabelFor</span>(model =&gt; model.<span class="hljs-type">ClassificationId</span>, htmlAttributes: <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"control-label col-md-2"</span> })
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-md-10"</span>&gt;
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DropDownList</span>(<span class="hljs-string">"ClassificationId"</span>, <span class="hljs-literal">null</span>, htmlAttributes: <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"form-control"</span> })
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">ValidationMessageFor</span>(model =&gt; model.<span class="hljs-type">ClassificationId</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"text-danger"</span> })
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-md-offset-2 col-md-10"</span>&gt;
                &lt;input <span class="hljs-class"><span class="hljs-keyword">type</span>=</span><span class="hljs-string">"submit"</span> value=<span class="hljs-string">"検索"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"btn btn-default"</span> /&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
}

<span class="hljs-annotation">@Html</span>.<span class="hljs-type">ActionLink</span>(<span class="hljs-string">"Create New"</span>, <span class="hljs-string">"Create"</span>, <span class="hljs-keyword">new</span> { <span class="hljs-type">Controller</span> = <span class="hljs-string">"Drugs"</span> })

@{
    <span class="hljs-comment">// ヘッダーの描画で使用</span>
    <span class="hljs-keyword">var</span> drug = <span class="hljs-keyword">new</span> <span class="hljs-type">WebApplication1</span>.<span class="hljs-type">Models</span>.<span class="hljs-type">Drugs</span>();
}

<span class="hljs-annotation">@if</span> (<span class="hljs-type">Model</span>.<span class="hljs-type">Drugs</span> != <span class="hljs-literal">null</span>)
{
&lt;table <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"table"</span>&gt;
    &lt;tr&gt;
        &lt;th&gt;
            <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DisplayNameFor</span>(model =&gt; drug.<span class="hljs-type">DrugCode</span>)
        &lt;/th&gt;
        &lt;th&gt;
            <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DisplayNameFor</span>(model =&gt; drug.<span class="hljs-type">Name</span>)
        &lt;/th&gt;
        &lt;th&gt;
            <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DisplayNameFor</span>(model =&gt; drug.<span class="hljs-type">Company</span>)
        &lt;/th&gt;
        &lt;th&gt;
            <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DisplayNameFor</span>(model =&gt; drug.<span class="hljs-type">Classifications</span>.<span class="hljs-type">ClassificationCode</span>)
        &lt;/th&gt;
        &lt;th&gt;&lt;/th&gt;
    &lt;/tr&gt;

    <span class="hljs-annotation">@foreach</span> (<span class="hljs-keyword">var</span> item in <span class="hljs-type">Model</span>.<span class="hljs-type">Drugs</span>)
    {
        &lt;tr&gt;
            &lt;td&gt;
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DisplayFor</span>(modelItem =&gt; item.<span class="hljs-type">DrugCode</span>)
            &lt;/td&gt;
            &lt;td&gt;
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DisplayFor</span>(modelItem =&gt; item.<span class="hljs-type">Name</span>)
            &lt;/td&gt;
            &lt;td&gt;
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DisplayFor</span>(modelItem =&gt; item.<span class="hljs-type">Company</span>)
            &lt;/td&gt;
            &lt;td&gt;
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">DisplayFor</span>(modelItem =&gt; item.<span class="hljs-type">Classifications</span>.<span class="hljs-type">ClassificationCode</span>)
            &lt;/td&gt;
            &lt;td&gt;
                <span class="hljs-annotation">@Html</span>.<span class="hljs-type">ActionLink</span>(<span class="hljs-string">"Details"</span>, <span class="hljs-string">"Details"</span>, <span class="hljs-keyword">new</span> { id = item.<span class="hljs-type">DrugId</span>, <span class="hljs-type">Controller</span> = <span class="hljs-string">"Drugs"</span> })
                <span class="hljs-annotation">@if</span> (string.<span class="hljs-type">IsNullOrEmpty</span>(item.<span class="hljs-type">DrugCode</span>))
                {
                    <span class="hljs-annotation">@Html</span>.<span class="hljs-type">Raw</span>(<span class="hljs-string">"|"</span>)
                    <span class="hljs-annotation">@Html</span>.<span class="hljs-type">ActionLink</span>(<span class="hljs-string">"Edit"</span>, <span class="hljs-string">"Edit"</span>, <span class="hljs-keyword">new</span> { id = item.<span class="hljs-type">DrugId</span>, <span class="hljs-type">Controller</span> = <span class="hljs-string">"Drugs"</span> })
                    <span class="hljs-annotation">@Html</span>.<span class="hljs-type">Raw</span>(<span class="hljs-string">"|"</span>)
                    <span class="hljs-annotation">@Html</span>.<span class="hljs-type">ActionLink</span>(<span class="hljs-string">"Delete"</span>, <span class="hljs-string">"Delete"</span>, <span class="hljs-keyword">new</span> { id = item.<span class="hljs-type">DrugId</span>, <span class="hljs-type">Controller</span> = <span class="hljs-string">"Drugs"</span> })
                }
            &lt;/td&gt;
        &lt;/tr&gt;
    }
&lt;/table&gt;
}

    &lt;script src=<span class="hljs-string">"~/Scripts/jquery-1.10.2.min.js"</span>&gt;&lt;/script&gt;
    &lt;script src=<span class="hljs-string">"~/Scripts/jquery.validate.min.js"</span>&gt;&lt;/script&gt;
    &lt;script src=<span class="hljs-string">"~/Scripts/jquery.validate.unobtrusive.min.js"</span>&gt;&lt;/script&gt;
</code></pre>
<p><br></p>
<p>検索項目の薬効分類はコンボボックスとしたいので、 <code>@Html.DropDownList</code> を使用します。</p>
<p>Createへのリンクを追加します。
異なるコントローラーのアクションメソッドに遷移するリンクを作成する場合、以下のように記述します。</p>
<pre><code class="lang-cs">@Html.<span class="hljs-function"><span class="hljs-title">ActionLink</span><span class="hljs-params">(<span class="hljs-string">"Create New"</span>, <span class="hljs-string">"Create"</span>, new { Controller = <span class="hljs-string">"Drugs"</span> })</span></span>
</code></pre>
<p><br></p>
<p>薬品コードが空でない薬品については編集・削除不可としますので
<code>Edit</code>、<code>Delete</code> のリンクを表示しないようにします。</p>
<p><br><br></p>
<h2 id="drugs-index-">Drugs/Indexの変更</h2>
<p>薬品コードが空でない薬品については編集・削除不可としますので
<code>Edit</code>、<code>Delete</code> のリンクを表示しないように修正します。</p>
<p><code>Views/Drugs/Index.cshtml</code></p>
<pre><code class="lang-html">:
&lt;td&gt;
    <span class="hljs-keyword">@Html</span>.ActionLink(<span class="hljs-string">"Details"</span>, <span class="hljs-string">"Details"</span>, <span class="hljs-keyword">new</span> { id = item.DrugId })
    <span class="hljs-keyword">@if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(item.DrugCode))
    {
        <span class="hljs-keyword">@Html</span>.Raw(<span class="hljs-string">"|"</span>)
        <span class="hljs-keyword">@Html</span>.ActionLink(<span class="hljs-string">"Edit"</span>, <span class="hljs-string">"Edit"</span>, <span class="hljs-keyword">new</span> { id=item.DrugId })
        <span class="hljs-keyword">@Html</span>.Raw(<span class="hljs-string">"|"</span>)
        <span class="hljs-keyword">@Html</span>.ActionLink(<span class="hljs-string">"Delete"</span>, <span class="hljs-string">"Delete"</span>, <span class="hljs-keyword">new</span> { id=item.DrugId })
    }
&lt;/td&gt;
:
</code></pre>
<p><br><br></p>
<h2 id="drugs-details-">Drugs/Detailsの変更</h2>
<p>薬品コードが空でない薬品については編集・削除不可としますので
<code>Edit</code> のリンクを表示しないように修正します。</p>
<p><code>Views/Drugs/Details.cshtml</code></p>
<pre><code class="lang-html">&lt;p&gt;
    <span class="hljs-keyword">@if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(Model.DrugCode)) {
        <span class="hljs-keyword">@Html</span>.ActionLink(<span class="hljs-string">"Edit"</span>, <span class="hljs-string">"Edit"</span>, <span class="hljs-keyword">new</span> { id = Model.DrugId })
        <span class="hljs-keyword">@Html</span>.Raw(<span class="hljs-string">"|"</span>)
    }
    <span class="hljs-keyword">@Html</span>.ActionLink(<span class="hljs-string">"Back to List"</span>, <span class="hljs-string">"Index"</span>)
&lt;/p&gt;
</code></pre>
<p><br><br></p>
<h2 id="drugs-create-">Drugs/Createの変更</h2>
<p>薬品コードは入力できないように、該当箇所をコメントアウトし、hiddenタグに置き換えます。</p>
<p><code>Views/Drugs/Create.cshtml</code></p>
<pre><code class="lang-html">@*
&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
    <span class="hljs-annotation">@Html</span>.<span class="hljs-type">LabelFor</span>(model =&gt; model.<span class="hljs-type">DrugCode</span>, htmlAttributes: <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"control-label col-md-2"</span> })
    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-md-10"</span>&gt;
        <span class="hljs-annotation">@Html</span>.<span class="hljs-type">EditorFor</span>(model =&gt; model.<span class="hljs-type">DrugCode</span>, <span class="hljs-keyword">new</span> { htmlAttributes = <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"form-control"</span> } })
        <span class="hljs-annotation">@Html</span>.<span class="hljs-type">ValidationMessageFor</span>(model =&gt; model.<span class="hljs-type">DrugCode</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"text-danger"</span> })
    &lt;/div&gt;
&lt;/div&gt;
*@
<span class="hljs-annotation">@Html</span>.<span class="hljs-type">HiddenFor</span>(model =&gt; model.<span class="hljs-type">DrugCode</span>)
</code></pre>
<p><br><br></p>
<h2 id="drugs-edit-">Drugs/Editの変更</h2>
<p>薬品コードが空でない薬品については変更不可とします。
URLを直接叩いて変更しようとするユーザーが存在するかもしれませんので、その対応を行います。</p>
<p><br><br></p>
<h3 id="controller-">Controllerの変更</h3>
<p>薬品コードが空でない薬品が選択された場合、BadRequestとして処理します。</p>
<p><code>Controllers/DrugsController.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-comment">// GET: Drugs/Edit/5</span>
<span class="hljs-keyword">public</span> <span class="hljs-function">ActionResult <span class="hljs-title">Edit</span><span class="hljs-params">(<span class="hljs-keyword">int</span>? id)</span>
</span>{
    <span class="hljs-keyword">if</span> (id == <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpStatusCodeResult(HttpStatusCode.BadRequest);
    }
    Drugs drugs = db.Drugs.Find(id);
    <span class="hljs-keyword">if</span> (drugs == <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">HttpNotFound</span><span class="hljs-params">()</span></span>;
    }
    <span class="hljs-comment">// 薬品コードが登録されている薬品は編集不可</span>
    <span class="hljs-keyword">if</span> (!string.IsNullOrEmpty(drugs.DrugCode))
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpStatusCodeResult(HttpStatusCode.BadRequest);
    }

    ViewBag.ClassificationId = db.Classifications.Select(item =&gt; <span class="hljs-keyword">new</span> SelectListItem
    {
        Text = item.ClassificationCode + <span class="hljs-string">":"</span> + item.Name,
        Value = item.ClassificationId.ToString(),
        Selected = item.ClassificationId == drugs.ClassificationId
    });

    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">View</span><span class="hljs-params">(drugs)</span></span>;
}
</code></pre>
<p><br><br></p>
<h3 id="view-">Viewの変更</h3>
<p>薬品コードは入力できないように、該当箇所をコメントアウトし、hiddenタグに置き換えます。</p>
<p><code>Views/Drugs/Edit.cshtml</code></p>
<pre><code class="lang-html">@*
&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
    <span class="hljs-annotation">@Html</span>.<span class="hljs-type">LabelFor</span>(model =&gt; model.<span class="hljs-type">DrugCode</span>, htmlAttributes: <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"control-label col-md-2"</span> })
    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-md-10"</span>&gt;
        <span class="hljs-annotation">@Html</span>.<span class="hljs-type">EditorFor</span>(model =&gt; model.<span class="hljs-type">DrugCode</span>, <span class="hljs-keyword">new</span> { htmlAttributes = <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"form-control"</span> } })
        <span class="hljs-annotation">@Html</span>.<span class="hljs-type">ValidationMessageFor</span>(model =&gt; model.<span class="hljs-type">DrugCode</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> { <span class="hljs-annotation">@class</span> = <span class="hljs-string">"text-danger"</span> })
    &lt;/div&gt;
&lt;/div&gt;
*@
<span class="hljs-annotation">@Html</span>.<span class="hljs-type">HiddenFor</span>(model =&gt; model.<span class="hljs-type">DrugCode</span>)
</code></pre>
<p><br><br></p>
<h2 id="delete-">Deleteの変更</h2>
<p>薬品コードが空でない薬品については削除不可とします。
URLを直接叩いて削除しようとするユーザーが存在するかもしれませんので、その対応を行います。</p>
<p>薬品コードが空でない薬品が選択された場合、BadRequestとして処理します。</p>
<p><code>Controllers/DrugsController.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-comment">// GET: Drugs/Delete/5</span>
<span class="hljs-keyword">public</span> <span class="hljs-function">ActionResult <span class="hljs-title">Delete</span><span class="hljs-params">(<span class="hljs-keyword">int</span>? id)</span>
</span>{
    <span class="hljs-keyword">if</span> (id == <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpStatusCodeResult(HttpStatusCode.BadRequest);
    }
    Drugs drugs = db.Drugs.Find(id);
    <span class="hljs-keyword">if</span> (drugs == <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">HttpNotFound</span><span class="hljs-params">()</span></span>;
    }
    <span class="hljs-comment">// 薬品コードが登録されている薬品は編集不可</span>
    <span class="hljs-keyword">if</span> (!string.IsNullOrEmpty(drugs.DrugCode))
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpStatusCodeResult(HttpStatusCode.BadRequest);
    }

    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">View</span><span class="hljs-params">(drugs)</span></span>;
}
</code></pre>
<p><br><br></p>
<h2 id="-">ルーティングの変更</h2>
<p><code>/Home/Index</code> がデフォルトとなるようにルーティングを変更します。</p>
<p><code>App_Start/RouteConfig.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Web;
<span class="hljs-keyword">using</span> System.Web.Mvc;
<span class="hljs-keyword">using</span> System.Web.Routing;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">WebApplication1</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RouteConfig</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RegisterRoutes</span>(<span class="hljs-params">RouteCollection routes</span>)
        </span>{
            routes.IgnoreRoute(<span class="hljs-string">"{resource}.axd/{*pathInfo}"</span>);

            routes.MapRoute(
                name: <span class="hljs-string">"Default"</span>,
                url: <span class="hljs-string">"{controller}/{action}/{id}"</span>,
                defaults: <span class="hljs-keyword">new</span> { controller = <span class="hljs-string">"Home"</span>, action = <span class="hljs-string">"Index"</span>, id = UrlParameter.Optional }
            );
        }
    }
}
</code></pre>
<p><br></p>
<p>ナビゲーション部分のタイトルをクリックしたら <code>/Home/Index</code> に遷移するように修正します。</p>
<p><code>Views/Shared/_Layout.cshtml</code></p>
<pre><code class="lang-html"><span class="xml">@</span><span class="hljs-expression">{
    <span class="hljs-variable">ViewBag.ApplicationName</span> = <span class="hljs-string">"薬品情報検索"</span>;
}</span><span class="xml">
<span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"viewport"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>@ViewBag.Title - @ViewBag.ApplicationName<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"~/Content/Site.css"</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/css"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"~/Content/bootstrap.min.css"</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/css"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"~/Scripts/modernizr-2.6.2.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar navbar-inverse navbar-fixed-top"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-header"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"button"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-toggle"</span> <span class="hljs-attribute">data-toggle</span>=<span class="hljs-value">"collapse"</span> <span class="hljs-attribute">data-target</span>=<span class="hljs-value">".navbar-collapse"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
                @Html.ActionLink((string)ViewBag.ApplicationName, "Index", "Home", new </span><span class="hljs-expression">{ <span class="hljs-variable">area</span> = <span class="hljs-string">""</span> }</span><span class="xml">, new </span><span class="hljs-expression">{ @<span class="hljs-variable">class</span> = <span class="hljs-string">"navbar-brand"</span> }</span><span class="xml">)
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-collapse collapse"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"nav navbar-nav"</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container body-content"</span>&gt;</span>
        @RenderBody()
        <span class="hljs-tag">&lt;<span class="hljs-title">hr</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">footer</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>&amp;copy; @DateTime.Now.Year - @ViewBag.ApplicationName<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"~/Scripts/jquery-1.10.2.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"~/Scripts/bootstrap.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></span>
</code></pre>
<p><br><br></p>
<hr>
<p><a href="./asp-202.html">次へ</a></p>
<p><br><br></p>
      </div>
      <div class="col-md-3">
        <div class="list-group">
  <a href="./index.html" class="list-group-item active">TOP</a>
  <a href="./about-001.html" class="list-group-item list-group-item-info">.NET Framework 概要</a>
  <a href="./classic-index.html" class="list-group-item list-group-item-info">.NET Framework アプリケーション開発入門</a>
  <a href="./classic-001.html" class="list-group-item">1. 簡単なコンソールアプリケーションの開発</a>
  <a href="./classic-002.html" class="list-group-item">2. Windowsフォームアプリケーションの開発</a>
  <a href="./classic-301.html" class="list-group-item">3. 非同期処理</a>
  <a href="./asp-index.html" class="list-group-item list-group-item-info">ASP.NET MVC開発入門</a>
  <a href="./webapp-intro.html" class="list-group-item">0. Webアプリケーションの定義</a>
  <a href="./asp-001.html" class="list-group-item">1. ASP.NET MVC の概要</a>
  <a href="./asp-002.html" class="list-group-item">2. ASP.NET MVC の基礎</a>
  <a href="./asp-101.html" class="list-group-item">3. EntityFramework によるデータベースファースト開発</a>
  <a href="./asp-201.html" class="list-group-item">4. 薬品情報検索システムの開発</a>
  <a href="#" class="list-group-item">5. メンバーシップ フレームワークによる認証機能の実装</a>
</div>
      </div>
    </div>
  </div>

  <br>
  <br>

  <div class="container">

    <div class="center-block ad-block">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- aaa-768x90 -->
      <ins class="adsbygoogle"
           style="display:inline-block;width:728px;height:90px"
           data-ad-client="ca-pub-5886049398949171"
           data-ad-slot="8568248344"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="text-muted">.NET アプリケーション開発入門 , &copy; 2015 Kazunori Kimura</p>
    </div>
  </footer>

  <script src="lib/js/jquery.min.js"></script>
  <script src="lib/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
  <script>
  $(function(){
    $(".contents table").addClass("table");
  });
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29149079-3', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
