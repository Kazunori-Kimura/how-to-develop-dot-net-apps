# 5. メンバーシップ フレームワークによる認証機能の実装 (後編)

## (1) ユーザーとロールの情報をデータベースで管理する

### Users, Rolesテーブルの追加

ユーザーとロールを管理するテーブルを作成します。

*User* と *Role* は 多対多の関係となるので
関連付けを管理する *UserRole* テーブルを作成します。

![ER図](./images/a3-ER.png)

```sql
CREATE TABLE [dbo].[Users] (
  [UserId] INT IDENTITY (1, 1) NOT NULL,
  [UserName] NVARCHAR (200) NOT NULL,
  [Password] NVARCHAR (200) NOT NULL,
  PRIMARY KEY CLUSTERED ([UserId] ASC)
);

CREATE TABLE [dbo].[Roles] (
  [RoleId] INT IDENTITY (1, 1) NOT NULL,
  [RoleName] NVARCHAR (200) NOT NULL,
  PRIMARY KEY CLUSTERED ([RoleId] ASC)
);

CREATE TABLE [dbo].[UserRole] (
  [UserID] INT NOT NULL,
  [RoleID] INT NOT NULL,
  CONSTRAINT [FK_dbo.UserRole_dbo.User_UserID] FOREIGN KEY ([UserID])
    REFERENCES [dbo].[Users] ([UserID]) ON DELETE CASCADE,
  CONSTRAINT [FK_dbo.UserRole_dbo.Role_RoleID] FOREIGN KEY ([RoleID])
    REFERENCES [dbo].[Roles] ([RoleID]) ON DELETE CASCADE
);
```

<br><br>

### 初期データの登録

```sql
insert into dbo.Users (UserName, Password) values ("administrator", "password");
insert into dbo.Users (UserName, Password) values ("user", "password");
insert into dbo.Roles (RoleName) values ("Administrators");
insert into dbo.Roles (RoleName) values ("Users");
```


<br><br>

### EDMファイルの更新

### *MembershipProvider* の更新

`Models/CustomMembershipProvider.cs`

```cs
public override bool ValidateUser(string username, string password)
{
    using (var db = new DrugInfoContext())
    {
        var user = db.Users
            .Where(u => u.UserName == username && u.Password == password)
            .FirstOrDefault();

        if (user != null)
        {
            // 認証OK
            return true;
        }
    }
    return false;
}
```

username, passwordを元にユーザーを取得します。

<br><br>

### *RoleProvider* の更新

`Models/CustomRoleProvider.cs`

```cs
public override bool IsUserInRole(string UserId, string roleName)
{
    using (var db = new DrugInfoContext())
    {
        int id = int.Parse(UserId);
        var user = db.Users
            .Where(u => u.Id == id)
            .FirstOrDefault();

        if (user != null) {
            string[] roles = user.Roles.Select(r => r.RoleName).ToArray();

            if (roles.Contains(roleName))
            {
                return true;
            }
        }
    }

    return false;
}
```

<br>

`IsUserInRole` は、指定されたユーザーが該当のロールに所属しているかを判定するメソッドです。

ユーザーIDを元にユーザーを検索し、ユーザーが所属するロールをチェックしています。

<br>

```cs
public override string[] GetRolesForUser(string UserId)
{
    using (var db = new DrugInfoContext())
    {
        int id = int.Parse(UserId);
        var user = db.Users
            .Where(u => u.Id == id)
            .FirstOrDefault();

        if (user != null) {
            string[] roles = user.Roles.Select(r => r.RoleName).ToArray();
            return roles;
        }
        return new string[] {};
    }
}
```

<br>

`GetRolesForUser` は、指定されたユーザーの所属するロールを配列で返します。

<br><br>

### 動作確認

<br><br>

## (2) ユーザー, ロールの管理画面の追加

### ControllerとViewの追加

それぞれ、Administratorsロールに所属しているユーザーのみ表示できるようにします。

* ユーザー
* ロール

<br><br>

### ナビゲーションバーにリンクを追加


<br><br>

### 動作確認

<br><br>

## (3) ロールによって画面表示を切り替える

### Razorで認証情報を参照する

```html
@if (Request.IsAuthenticated && User.IsInRole("Administrators"))
{
     <div id="sidebar">
        <div class="module">
           <ul class="menu">
              <li>@Html.ActionLink("Home", "Index", "Home")</li>
              <li>@Html.ActionLink("About", "About", "Home")</li>
              <li>@Html.ActionLink("Contact", "Contact", "Home")</li>
            </ul>
         </div>
         <div class="mainContent">
             Hello, @User.Identity.Name !
         </div>
     </div>
}
```

### Viewの修正

`_Layout.cshtml`

* 認証されていれば、以下のリンクを表示する
  - ログアウト
* Administratorsであれば、以下のリンクを表示する
  - 薬効分類
  - ユーザー管理
  - ロール管理


### 動作確認

<br><br>
