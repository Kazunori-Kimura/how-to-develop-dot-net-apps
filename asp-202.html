<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <title>.NET アプリケーション開発入門</title>
  <!-- Bootstrap -->
  <link href="./lib/css/bootstrap.min.css" rel="stylesheet">
  <link href="./css/base.css" rel="stylesheet">
  <!-- highlightjs -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://kazunori-kimura.github.io/how-to-develop-dot-net-apps/"><i class="fa fa-code"></i> .NET アプリケーション開発入門</a>
      </div>
      <p class="navbar-text navbar-right">
        <a href="https://github.com/Kazunori-Kimura/introduction-to-asp-dot-net" class="navbar-link" target="_blank">
          <i class="fa fa-github"></i>
          View on GitHub
        </a>
        &nbsp;
      </p>
    </div>
  </nav>

  <div class="container-fluid contents">
    <div class="row">
      <div class="col-md-2"></div>
      <div class="col-md-7">
        <!-- contents -->
        <h1 id="-">薬品情報検索システムの機能追加</h1>
<h2 id="-">検索条件の保持</h2>
<p>これまでの実装では、他画面に遷移した後に <code>/Home/Index</code> に戻ってくると、
検索結果が失われていました。</p>
<p>前回の検索結果を復元するように機能を追加します。</p>
<p><br><br></p>
<h3 id="-">用語解説: セッション</h3>
<p><em>HTTP</em> には、画面遷移間で一連の処理であることを識別する仕様はありません。<br>このことを <em>HTTPはステートレスなプロトコルである</em> 、と言います。</p>
<p>ログイン情報などをWebアプリケーションで保持するために、<em>セッション</em> という仕組みがあります。</p>
<p><img src="./images/diagram.svg" alt="image"></p>
<p><br><br></p>
<h3 id="-">検索条件を保持する</h3>
<p><em>Home/Index</em> で <em>POST</em> されてきた際に、
検索条件を <em>Session</em> に格納するように機能を追加します。</p>
<p><code>Controllers/HomeController.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-comment">// POST: Home</span>
[HttpPost]
[ValidateAntiForgeryToken]
public ActionResult <span class="hljs-literal">Index</span>([Bind(<span class="hljs-keyword">Include</span> = <span class="hljs-string">"DrugName,ClassificationId"</span>)] SearchViewModel model)
{
    <span class="hljs-keyword">if</span> (ModelState.IsValid)
    {
        <span class="hljs-comment">// 検索処理</span>
        <span class="hljs-keyword">var</span> <span class="hljs-keyword">list</span> = <span class="hljs-keyword">db</span>.Drugs.Where(item =&gt;
            (string.IsNullOrEmpty(model.DrugName) || item.Name.Contains(model.DrugName))
            &amp;&amp; (model.ClassificationId == 0 || item.ClassificationId == model.ClassificationId)).ToList();
        model.Drugs = <span class="hljs-keyword">list</span>;

        <span class="hljs-comment">// 検索条件を復元するためにSessionに保持</span>
        Session[<span class="hljs-string">"DrugName"</span>] = model.DrugName;
        Session[<span class="hljs-string">"ClassificationId"</span>] = model.ClassificationId;
    }
    this.SetClassificationItems();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">View</span>(model);
}
</code></pre>
<p><br><br></p>
<h3 id="-">検索条件を復元する</h3>
<p><em>Home/Index</em> に <em>GET</em> された際に
<em>Session</em> に検索条件が格納されている場合は、それを復元します。</p>
<p><code>Controllers/HomeController.cs</code></p>
<p><em>ViewBag</em> にコンボボックスの項目をセットするメソッドを修正し、初期選択値を指定できるようにします。</p>
<pre><code class="lang-cs"><span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> ViewBagにコンボボックスの項目をセット</span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetClassificationItems</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">this</span>.SetClassificationItems(<span class="hljs-number">0</span>);
}

<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> ViewBagにコンボボックスの項目をセット</span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;param name="selectedId"&gt;</span>初期選択<span class="hljs-xmlDocTag">&lt;/param&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetClassificationItems</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> selectedId</span>)
</span>{
    <span class="hljs-keyword">var</span> list = db.Classifications.Select(item =&gt; <span class="hljs-keyword">new</span> SelectListItem
    {
        Text = item.ClassificationCode + <span class="hljs-string">":"</span> + item.Name,
        Value = item.ClassificationId.ToString(),
        Selected = item.ClassificationId == selectedId
    }).ToList();

    <span class="hljs-comment">// 先頭にブランクを挿入</span>
    list.Insert(<span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> SelectListItem {
        Text = <span class="hljs-keyword">string</span>.Empty,
        Value = <span class="hljs-string">"0"</span>,
        Selected = selectedId == <span class="hljs-number">0</span>
    });

    ViewBag.ClassificationId = list;
}
</code></pre>
<p><br></p>
<p>つづいて、<em>Session</em> に検索条件がセットされている場合はそれを取り出し
検索結果を表示するように修正します。</p>
<pre><code class="lang-cs"><span class="hljs-comment">// GET: Home</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> ActionResult <span class="hljs-title">Index</span><span class="hljs-params">()</span>
</span>{
    var model = <span class="hljs-keyword">new</span> SearchViewModel();
    model.ClassificationId = <span class="hljs-number">0</span>; <span class="hljs-comment">// コンボボックスの初期選択</span>

    <span class="hljs-keyword">if</span> (Session[<span class="hljs-string">"DrugName"</span>] != null || Session[<span class="hljs-string">"ClassificationId"</span>] != null)
    {
        model.DrugName = (<span class="hljs-built_in">string</span>)Session[<span class="hljs-string">"DrugName"</span>];
        model.ClassificationId = (<span class="hljs-keyword">int</span>)Session[<span class="hljs-string">"ClassificationId"</span>];

        <span class="hljs-comment">// 検索処理</span>
        var <span class="hljs-built_in">list</span> = db.Drugs.Where(item =&gt;
            (<span class="hljs-built_in">string</span>.IsNullOrEmpty(model.DrugName) || item.Name.Contains(model.DrugName))
            &amp;&amp; (model.ClassificationId == <span class="hljs-number">0</span> || item.ClassificationId == model.ClassificationId)).ToList();
        model.Drugs = <span class="hljs-built_in">list</span>;
    }

    <span class="hljs-comment">// コンボボックスの項目を設定</span>
    <span class="hljs-keyword">this</span>.SetClassificationItems(model.ClassificationId);

    <span class="hljs-keyword">return</span> View(model);
}
</code></pre>
<p><br><br></p>
<h2 id="-">薬効分類のメンテナンス画面を追加</h2>
<p>薬効分類のメンテナンス機能を追加します。</p>
<p><em>EntityFrameworkのデータベースファースト開発</em> によって
<code>ClassificationsController</code> と各ビューを自動生成します。</p>
<p><br><br></p>
<h3 id="-">コントローラー、ビューの自動生成</h3>
<p><em>ソリューション エクスプローラー</em> で <em>Controllers</em> を右クリック -&gt; <em>追加</em> -&gt;
<em>新規スキャフォールディングアイテム</em> を選択します。</p>
<p><img src="./images/a2-12.JPG" alt="image">
<br></p>
<p><em>Entity Framework を使用した、ビューがあるMVC5 コントローラー</em> を選択し、<em>追加</em> をクリックします。</p>
<p><img src="./images/a2-13.JPG" alt="image">
<br></p>
<p><em>モデル クラス</em> に <code>Classifications</code> 、 <em>データ コンテキスト クラス</em> に <code>DrugInfoContext</code> を選択し、<em>追加</em> をクリックします。</p>
<p><img src="./images/a2-14.JPG" alt="image"></p>
<p><br><br></p>
<h3 id="classifications-">Classifications の メタデータクラスを確認</h3>
<p><code>Models/ClassificationsMetadata.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System.ComponentModel;
<span class="hljs-keyword">using</span> System.ComponentModel.DataAnnotations;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">WebApplication1.Models</span>
{
    [MetadataType(<span class="hljs-keyword">typeof</span>(ClassificationsMetadata))]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Classifications</span>
    {
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClassificationsMetadata</span>
    {
        [DisplayName(<span class="hljs-string">"薬効分類ID"</span>)]
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> ClassificationId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [DisplayName(<span class="hljs-string">"薬効分類コード"</span>)]
        [Required(ErrorMessage = <span class="hljs-string">"薬効分類コードは必須項目です。"</span>)]
        [StringLength(<span class="hljs-number">3</span>, ErrorMessage = <span class="hljs-string">"薬効分類コードは3桁で入力してください。"</span>)]
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> ClassificationCode { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [DisplayName(<span class="hljs-string">"薬効分類"</span>)]
        [Required(ErrorMessage = <span class="hljs-string">"薬効分類名称は必須項目です。"</span>)]
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
}
</code></pre>
<p><br><br></p>
<h3 id="-">ナビゲーションバーの変更</h3>
<p>ナビゲーションバーに薬効分類の一覧へ遷移するリンクを追加します。</p>
<pre><code class="lang-html"><span class="xml">@</span><span class="hljs-expression">{
    <span class="hljs-variable">ViewBag.ApplicationName</span> = <span class="hljs-string">"薬品情報検索"</span>;
}</span><span class="xml">
<span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"viewport"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>@ViewBag.Title - @ViewBag.ApplicationName<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"~/Content/Site.css"</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/css"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"~/Content/bootstrap.min.css"</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/css"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"~/Scripts/modernizr-2.6.2.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar navbar-inverse navbar-fixed-top"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-header"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"button"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-toggle"</span> <span class="hljs-attribute">data-toggle</span>=<span class="hljs-value">"collapse"</span> <span class="hljs-attribute">data-target</span>=<span class="hljs-value">".navbar-collapse"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
                @Html.ActionLink((string)ViewBag.ApplicationName, "Index", "Home", new </span><span class="hljs-expression">{ <span class="hljs-variable">area</span> = <span class="hljs-string">""</span> }</span><span class="xml">, new </span><span class="hljs-expression">{ @<span class="hljs-variable">class</span> = <span class="hljs-string">"navbar-brand"</span> }</span><span class="xml">)
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-collapse collapse"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"nav navbar-nav"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">li</span>&gt;</span>
                        @Html.ActionLink("薬効分類", "Index", new </span><span class="hljs-expression">{ <span class="hljs-variable">Controller</span> = <span class="hljs-string">"Classifications"</span> }</span><span class="xml">)
                    <span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container body-content"</span>&gt;</span>
        @RenderBody()
        <span class="hljs-tag">&lt;<span class="hljs-title">hr</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">footer</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>&amp;copy; @DateTime.Now.Year - @ViewBag.ApplicationName<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"~/Scripts/jquery-1.10.2.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"~/Scripts/bootstrap.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></span>
</code></pre>
<p><br><br></p>
<hr>
<p>検索機能と薬効分類のメンテナンス機能の追加を行いました。</p>
<p>次回は認証機能を追加し、アプリケーションを完成させます。</p>
<p><br><br></p>
      </div>
      <div class="col-md-3">
        <div class="list-group">
  <a href="./index.html" class="list-group-item active">TOP</a>
  <a href="./about-001.html" class="list-group-item list-group-item-info">.NET Framework 概要</a>
  <a href="./classic-index.html" class="list-group-item list-group-item-info">.NET Framework アプリケーション開発入門</a>
  <a href="./classic-001.html" class="list-group-item">1. 簡単なコンソールアプリケーションの開発</a>
  <a href="./classic-002.html" class="list-group-item">2. Windowsフォームアプリケーションの開発</a>
  <a href="./classic-301.html" class="list-group-item">3. 非同期処理</a>
  <a href="./asp-index.html" class="list-group-item list-group-item-info">ASP.NET MVC開発入門</a>
  <a href="./webapp-intro.html" class="list-group-item">0. Webアプリケーションの定義</a>
  <a href="./asp-001.html" class="list-group-item">1. ASP.NET MVC の概要</a>
  <a href="./asp-002.html" class="list-group-item">2. ASP.NET MVC の基礎</a>
  <a href="./asp-101.html" class="list-group-item">3. EntityFramework によるデータベースファースト開発</a>
  <a href="./asp-201.html" class="list-group-item">4. 薬品情報検索システムの開発</a>
  <a href="#" class="list-group-item">5. メンバーシップ フレームワークによる認証機能の実装</a>
</div>
      </div>
    </div>
  </div>

  <br>
  <br>

  <div class="container">

    <div class="center-block ad-block">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- aaa-768x90 -->
      <ins class="adsbygoogle"
           style="display:inline-block;width:728px;height:90px"
           data-ad-client="ca-pub-5886049398949171"
           data-ad-slot="8568248344"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="text-muted">.NET アプリケーション開発入門 , &copy; 2015 Kazunori Kimura</p>
    </div>
  </footer>

  <script src="lib/js/jquery.min.js"></script>
  <script src="lib/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
  <script>
  $(function(){
    $(".contents table").addClass("table");
  });
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29149079-3', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
